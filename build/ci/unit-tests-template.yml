# Template used by unit-tests.yml
jobs:
- job: ${{ parameters.name }}
  pool: ${{ parameters.pool }}
  timeoutInMinutes: 20
  steps:
    - checkout: none

    - script: |
        @echo on
        @git version
        git init
        git fetch --no-auto-gc --no-recurse-submodules --no-show-forced-updates --no-tags --depth=1 "$(Build.Repository.Uri)" "$(Build.SourceVersion)"
        git -c advice.detachedHead=false checkout --no-progress "$(Build.SourceVersion)"
      displayName: Shallow Checkout

    - script: $(Build.SourcesDirectory)\build.cmd /build /test /ci /sign /diagnostic /clearnugetcache /no-deploy /no-integration /no-ibc /configuration ${{ parameters.configuration }}
      displayName: Build ProjectSystem.sln

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)\artifacts\${{ parameters.configuration }}\log'
        ArtifactName: '${{ parameters.configuration }} Log folder'
        publishLocation: Container
      continueOnError: true
      condition: failed()

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)\artifacts\${{ parameters.configuration }}\bin'
        ArtifactName: '${{ parameters.configuration }} Bin folder'
        publishLocation: Container
      continueOnError: true
      condition: failed()

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)\artifacts\${{ parameters.configuration }}\VSSetup'
        ArtifactName: '${{ parameters.configuration }} VSSetup folder'
        publishLocation: Container
      continueOnError: true
      condition: failed()

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)\artifacts\${{ parameters.configuration }}\TestResults'
        ArtifactName: '${{ parameters.configuration }} TestResults folder'
        publishLocation: Container
      continueOnError: true
      condition: failed()

    - task: PublishTestResults@2
      inputs:
        testRunner: 'xUnit'	
        testResultsFiles: '**/*.xml' 	
        searchFolder: '$(Build.SourcesDirectory)\artifacts\${{ parameters.configuration }}\TestResults'	
        configuration: '${{ parameters.configuration }}'	
        publishRunAttachments: true	
        failTaskOnFailedTests: true
      continueOnError: true
      condition: always()  